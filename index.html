<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Wazi Hub — See More. Know More. Do More.</title>
<meta name="description" content="Wazi Hub: Kenya Public Finance & Projects Dashboard — budget transparency, contracting openness, project tracking, and citizen feedback." />
<meta name="author" content="Wazi Hub" />
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 48 48'%3E%3Crect width='48' height='16' y='0' fill='%23000000'/%3E%3Crect width='48' height='16' y='16' fill='%23BB1919'/%3E%3Crect width='48' height='16' y='32' fill='%2300853F'/%3E%3C/svg%3E" />
<!-- <a href="https://www.flaticon.com/free-icons/kenya" title="kenya icons">Kenya icons created by Roundicons - Flaticon</a> -->
<!-- Chart.js (for interactive charts) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

<!-- Leaflet (interactive map) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  /* ===== CSS RESET + BASE ===== */
  *, *::before, *::after { box-sizing: border-box; }
  html:focus-within { scroll-behavior: smooth; }
  body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial, "Noto Sans"; line-height:1.5; color:#0b0c0c; background:#f7f7f7; }
  img, svg, video, canvas { max-width:100%; height:auto; }
  :root{
    --kenya-black:#00853F; --kenya-red:#00853F; --kenya-green:#00853F; --kenya-white:#FFFFFF;
    --ink:#101314; --muted:#5a6672; --card:#ffffff; --border:#e7e7e7; --focus:#005bd3; --radius:16px;
  }
  .container{ max-width:1100px; margin-inline:auto; padding: clamp(14px, 2vw, 18px); }
  .skip{ position: absolute; left:-9999px; top:auto; width:1px; height:1px; overflow:hidden;}
  .skip:focus{ position: static; width:auto; height:auto; background:#fff; padding:.5rem .75rem; border:2px solid var(--focus); border-radius:10px; z-index:9999;}
  .muted{ color:white; }
  .mute{ color: black;}

  /* ===== HEADER ===== */
  .site-header{ position:sticky; top:0; z-index:20; background:linear-gradient(90deg,var(--kenya-black) 0 30%, var(--kenya-red) 30% 65%, var(--kenya-green) 65% 100%); box-shadow: 0 2px 10px rgba(0,0,0,.12); }
  /*  */

  .brand{ display:flex; align-items:center; gap:.5rem; padding:0; }
  .brand .logo{ width:42px; height:28px; border:2px solid #fff; border-radius:4px; display:grid; grid-template-rows:1fr 1fr 1fr; overflow:hidden; }
  .brand .logo span:nth-child(1){ background:var(--kenya-black); }
  .brand .logo span:nth-child(3){ background:var(--kenya-green); }
  .brand h1{ margin:0; font-size: clamp(1.25rem, 3vw, 1.75rem); color:#fff; letter-spacing:.2px; }
  .brand small{ color:#fff; opacity:.9; font-weight:600; font-size:.9rem; }

  nav ul{ list-style:none; margin:0; padding:0; display:flex; flex-wrap:wrap; gap:.25rem .5rem; }
  nav a{ display:inline-block; padding:.32rem .6rem; font-weight:700; text-decoration:none; background:rgba(255,255,255,.08); color:#fff; border:1px solid rgba(255,255,255,.28); border-radius:999px; transition: background .15s ease, color .15s ease, transform .06s ease; }
  nav a:hover, nav a:focus{ background:#fff; color:var(--kenya-black); outline: none; transform: translateY(-1px); }
  header h1 {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    header h1 img {
      width: 24px;
      height: auto;
    }
  /* Keep header slim without affecting other containers */
  .site-header .container{ padding-top:6px; padding-bottom:6px; }
  /* ===== HERO ===== */
  #home{ background: radial-gradient(1200px 350px at 50% -50px, #ffffff 0%, #f3f5f6 60%, #eef1f2 100%); border-bottom:1px solid var(--border); position: relative; }
  #home h2{ font-size: clamp(1.8rem, 4.5vw, 2.6rem); margin: .5rem 0; }
  .cta-row{ display:flex; flex-wrap:wrap; gap:.75rem; margin-top:.75rem; }
  #home {
      background-image: url('https://i.postimg.cc/CMrR51wd/Chat-GPT-Image-Aug-27-2025-12-07-41-AM.png');
      background-size: cover;
      background-position: center 35%;
      color: white;
    }
  #home::before{ content:""; position:absolute; inset:0; background: linear-gradient(180deg, rgba(0,0,0,0.35) 0%, rgba(0,0,0,0.2) 30%, rgba(0,0,0,0.25) 100%); pointer-events:none; }
  #home .container{ position:relative; z-index:1; padding-top: 2.25rem; padding-bottom:2.25rem; min-height: 48vh; display:flex; flex-direction:column; justify-content:center; }
  /* ===== UTILS ===== */
  .flex{ display:flex; gap:.75rem; align-items:center;}
  .grid{ display:grid; gap:1rem; }
  .grid-2{ grid-template-columns: repeat(2, minmax(0,1fr)); }
  .grid-3{ grid-template-columns: repeat(3, minmax(0,1fr)); }
  @media (max-width: 900px){ .grid-3{ grid-template-columns:1fr; } .grid-2{ grid-template-columns:1fr; } nav ul{ justify-content: center; } }
  .btn{ --bg:var(--kenya-green); --fg:#fff;
    background: var(--bg); color:var(--fg); border:0; border-radius:999px; padding:.85rem 1.1rem; font-weight:800; text-decoration:none; display:inline-flex; gap:.5rem; align-items:center; justify-content:center; cursor:pointer; box-shadow: 0 6px 14px rgba(0,0,0,.18); transform: translateY(0); transition: transform .12s ease, box-shadow .12s ease, filter .12s ease; }
  .btn:hover{ filter: brightness(1.02); transform: translateY(-1px); box-shadow: 0 10px 18px rgba(0,0,0,.22);} 
  .btn:active{ transform: translateY(1px); box-shadow: 0 4px 10px rgba(0,0,0,.18);} 
  .btn.secondary{ --bg:#fff; --fg:var(--kenya-black); border:2px solid var(--kenya-black);}
  .badge{ display:inline-block; padding:.2rem .55rem; border-radius:999px; font-weight:700; font-size:.8rem; background:#eee; }
  .badge[data-status="ongoing"]{ background:#e8f6ee; color:#0c7a43; }
  .badge[data-status="awarded"]{ background:#fff1f1; color:#9c1c1c; }

  /* ===== CARDS / PANELS ===== */
  .card{ background:var(--card); border:1px solid var(--border); border-radius:var(--radius); padding:1rem; box-shadow: 0 2px 10px rgba(0,0,0,.05); }
  .panel-title{ font-size:1.15rem; font-weight:800; margin: 0 0 .5rem; }

  /* ===== CHART AREAS ===== */
  .chart-wrap{ background: #ffffff; border:1px solid var(--border); border-radius: var(--radius); padding: .9rem; }
  .chart-box{ position:relative; height: 260px; }
  @media (min-width: 1100px){ .chart-box{ height: 280px; } }
  .chart-box{ position:relative; height: 220px; }
  @media (min-width: 1100px){ .chart-box{ height: 260px; } }
  .legend{ display:grid; grid-template-columns: repeat(2,minmax(0,1fr)); gap:.4rem .75rem; margin-top:.5rem; font-size:.95rem; }

  /* ===== TABLE ===== */
  table{ width:100%; border-collapse: separate; border-spacing:0; background:#fff; border:1px solid var(--border); border-radius:12px; overflow:hidden; }
  th, td{ padding:.9rem; border-bottom:1px solid var(--border); text-align:left; font-size:1rem; }
  thead th{ position: sticky; top: 0; background:#f3f5f6; font-size:1.05rem; z-index:1; }
  tbody tr:nth-child(odd){ background:#fafafa; }
  tbody tr:hover{ background:#f2f7f4; }
  caption{ padding:.5rem; }

  /* ===== FORM ===== */
  label{ display:flex; flex-direction:column; gap:.45rem; font-weight:700; }
  input, select, textarea{ padding:.7rem .8rem; border:1px solid #d8d8d8; border-radius:12px; font-size:1rem; background:#fff; }
  input:focus, select:focus, textarea:focus, .btn:focus{ outline:3px solid #90c2ff; outline-offset:2px; }
  progress{ width:100%; height:14px; accent-color: var(--kenya-green); }

  /* ===== USSD/WHATSAPP ===== */
  .channels{ display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:1rem; }
  @media (max-width: 700px){ .channels{ grid-template-columns: 1fr; } }
  .channel{ display:flex; gap:1rem; align-items:center; padding:1rem; background:#ffffff; border:1px solid var(--border); border-radius:var(--radius); }
  .channel svg{ width:44px; height:44px; }
  .channel .big{ font-weight:900; font-size: clamp(1.05rem, 2.8vw, 1.25rem); }
  .ussd{ background: #f2fff7; border-color:#cceedd; }
  .whatsapp{ background:#f4fff8; border-color:#cfeedd; }

  /* ===== MAP ===== */
  #map{ height:280px; border:1px solid var(--border); border-radius:var(--radius); }
  #map{ height:280px; border:1px solid var(--border); border-radius:var(--radius); touch-action: pan-y; }

  /* ===== FOOTER ===== */
  footer{ background:#0d0f10; color:#e9eef2; margin-top: 2rem; border-top: 1px solid rgba(255,255,255,.06); }
  footer a{ color:#cfe3ff; }

  /* === Virtual Barazas Section === */
  #barazas-section { margin-top: 18px; }
  #barazas-section .small-muted{ color: var(--muted); font-size: .95rem; }
  #baraza-container { display: flex; flex-direction: column; gap: 12px; }
  .baraza-item { display: flex; flex-direction: column; gap: 8px; padding: 12px; margin-bottom: 12px; border-radius: 12px; border: 1px solid var(--border); background: linear-gradient(180deg, #fff, #f9fafb); box-shadow: 0 2px 6px rgba(0, 0, 0, .04); transition: transform .15s ease, box-shadow .15s ease; }
  .baraza-item:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,.08); }
  .baraza-meta { display: flex; justify-content: space-between; gap: 12px; flex-wrap: wrap; align-items: center; }
  .baraza-title { font-size: 1.05rem; font-weight: 800; margin: 0; }
  .baraza-datetime { color: var(--muted); font-size: .9rem; }
  .baraza-actions { display: flex; gap: 8px; align-items: center; }
  .join-btn { background: linear-gradient(90deg, var(--kenya-green, #00853F), #0b7a3a); color: #fff; border: 0; padding: 6px 12px; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: .9rem; transition: background .2s ease; }
  .join-btn:hover { background: var(--kenya-green, #00853F); }
  .recording-link { background: #fff; border: 1px solid #ddd; padding: 6px 12px; border-radius: 8px; cursor: pointer; font-size: .85rem; text-decoration: none; color: inherit; }
  .vote-btn { padding: 4px 8px; border-radius: 6px; border: 1px solid #ddd; background: #f3f4f6; cursor: pointer; font-weight: 700; font-size: .9rem; transition: background .2s ease; }
  .vote-btn:hover { background: #e5e7eb; }
  .baraza-controls { display:flex; flex-wrap: wrap; gap:.5rem; align-items: end; margin-top:.5rem; }
  .tabs { display:flex; gap:.5rem; }
  .tab-btn { padding:.5rem .8rem; border:1px solid var(--border); background:#fff; border-radius:999px; cursor:pointer; font-weight:700; }
  .tab-btn.active { background: var(--kenya-green); color:#fff; border-color: transparent; }
  .chip { display:inline-flex; align-items:center; gap:.35rem; padding:.2rem .6rem; border-radius:999px; background:#eef3f0; color:#0b5130; font-weight:700; font-size:.8rem; }
  .badge-live { background:#dc2626; color:#fff; padding:.1rem .4rem; border-radius:6px; font-size:.75rem; font-weight:800; }
  .badge-soon { background:#f59e0b; color:#111; padding:.1rem .4rem; border-radius:6px; font-size:.75rem; font-weight:800; }
  .baraza-line2 { display:flex; flex-wrap:wrap; gap:.5rem; align-items:center; color:var(--muted); font-size:.9rem; }
  .baraza-cta { display:flex; flex-wrap:wrap; gap:.4rem; align-items:center; }
  .small-btn { padding:6px 10px; border-radius:8px; border:1px solid #ddd; background:#fff; cursor:pointer; font-weight:700; font-size:.85rem; }
  .small-btn.primary { background:#0b7a3a; color:#fff; border:0; }
  .countdown { font-variant-numeric: tabular-nums; font-weight:800; }
  .hl-wrap { display:flex; flex-direction:column; gap:.4rem; margin-top:.4rem; }
  .hl { display:flex; justify-content:space-between; align-items:center; gap:.5rem; padding:.5rem .6rem; border:1px solid var(--border); border-radius:8px; background:#fff; }
  .hl-text { flex:1; color:#111; }
  .hl-votes { display:flex; align-items:center; gap:.25rem; }
  .overlay { position: fixed; inset: 0; background: rgba(0,0,0,.6); display: none; align-items: center; justify-content: center; z-index: 3000; padding: 12px; }
  .overlay.open { display: flex; }
  .modal { width: min(1000px, 96%); height: min(80vh, 850px); background: #000; border-radius: 10px; overflow: hidden; display: flex; flex-direction: column; }
  .modal .toolbar { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; color: #fff; background: rgba(255,255,255,.08); }
  .modal .iframe-wrap { flex: 1; background: #000; }
  .copy-btn { background: #fff; color: #000; border-radius: 8px; padding: 6px 10px; border: 0; cursor: pointer; }
  .close-x { background: transparent; color: #fff; border: 0; font-size: 18px; padding: 6px 8px; cursor: pointer; }
</style>
</head>
<body>
<a href="#main" class="skip">Skip to content</a>

<!-- ===== HEADER ===== -->
<header class="site-header" role="banner">
  <div class="container" style="display:flex; justify-content:space-between; align-items:center; gap:.75rem; flex-wrap:wrap;">
    <div class="brand" aria-label="Wazi Hub home">
      <!-- <div class="logo" aria-hidden="true"><span></span><span></span><span></span></div> -->
    <div>
        <!-- <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/4/49/Flag_of_Kenya.svg/1920px-Flag_of_Kenya.svg.png" alt="Kenya Flag"> -->
        <!-- <h1 data-i18n="brand.name">WaziHub</h1> -->
        <h1>
        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/4/49/Flag_of_Kenya.svg/1920px-Flag_of_Kenya.svg.png" alt="Kenya Flag">
        WaziHub
        </h1>
        <small data-i18n="brand.tag">See More • Know More • Do More</small>
      </div>
    </div>
    <nav aria-label="Primary">
      <ul>
        <li><a href="#home" data-i18n="nav.home">Home</a></li>
        <li><a href="#budget-tracker" data-i18n="nav.budgets">Budgets</a></li>
        <li><a href="#open-contracting" data-i18n="nav.contracts">Contracts</a></li>
        <li><a href="#projects" data-i18n="nav.projects">Projects</a></li>
        <li><a href="#barazas-section" data-i18n="nav.barazas">Barazas</a></li>
        <li><a href="#report" data-i18n="nav.report">Report</a></li>
      </ul>
    </nav>
  </div>
</header>

<main id="main" tabindex="-1">
  <!-- ===== HERO ===== -->
  <section id="home">
    <div class="container">
      <h2 aria-live="polite" data-i18n="hero.title">See More. Know More. Do More.</h2>
      <p class="muted" style="font-size:1.1rem; max-width:65ch;" data-i18n="hero.text">
        Track budgets, monitor projects, follow contracts, and hold leaders accountable — all in one easy dashboard built for everyone in Kenya.
      </p>
      <div class="cta-row">
        <a class="btn" href="#budget-tracker" style="--bg:var(--kenya-green)" data-i18n="cta.budgets">Explore Budgets</a>
        <a class="btn secondary" href="#open-contracting" data-i18n="cta.contracts">Open Contracting</a>
        <a class="btn" href="#report" style="--bg:var(--kenya-red)" data-i18n="cta.report">Report an Issue</a>
      </div>
    </div>
  </section>

  <!-- ===== HIGHLIGHTS ===== -->
  <section id="highlights" class="container" aria-labelledby="highlights-title" style="margin-top:1rem;">
    <h3 id="highlights-title" class="panel-title" data-i18n="hl.title">Highlights</h3>
    <div class="grid grid-3">
      <article class="card">
        <h4 class="panel-title" style="color:var(--kenya-red)" data-i18n="hl.a.title">Where is your county’s money going?</h4>
        <p class="mute" data-i18n="hl.a.text">Quick view of allocations by sector for your county.</p>
      </article>
      <article class="card">
        <h4 class="panel-title" style="color:var(--kenya-red)" data-i18n="hl.b.title">Who won the latest tenders?</h4>
        <p class="mute" data-i18n="hl.b.text">Search contractors, awards, and red flags.</p>
      </article>
      <article class="card">
        <h4 class="panel-title" style="color:var(--kenya-red)" data-i18n="hl.c.title">Is that road really 80% complete?</h4>
        <p class="mute" data-i18n="hl.c.text">Project statuses, photos, and community updates.</p>
      </article>
    </div>
  </section>

  <!-- ===== LANGUAGE SELECTOR (ABOVE BUDGET TRACKER) ===== -->
  <section id="language-bar" aria-label="Language switcher">
    <div class="container card" style="display:flex; justify-content:space-between; align-items:center; gap:1rem; flex-wrap:wrap;">
      <div class="flex" style="gap:.5rem;">
        <strong data-i18n="lang.label">Language / Lugha:</strong>
        <span class="muted" data-i18n="lang.beta">Translation (Beta)</span>
      </div>
      <div class="flex" style="gap:.5rem;">
        <select id="language-select" aria-label="Choose language">
          <option value="en">English</option>
          <option value="sw">Kiswahili</option>
          <option value="ki">Gikuyu</option>
          <option value="luo">Dholuo</option>
          <option value="kamba">Kikamba</option>
          <option value="luy">Luhya</option>
          <option value="kal">Kalenjin</option>
          <option value="som">Somali</option>
          <option value="tuk">Turkana</option>
          <option value="meru">Kĩmerũ</option>

        </select>
        <button class="btn" id="apply-lang" type="button" style="--bg:var(--kenya-black)" data-i18n="lang.apply">Apply</button>
      </div>
    </div>
  </section>

  <!-- ===== BUDGET TRACKER ===== -->
  <section id="budget-tracker" aria-labelledby="budget-title" style="margin-top:.5rem;">
    <div class="container">
      <h3 id="budget-title" class="panel-title" style="font-size:1.6rem;" data-i18n="budget.title">Open Budget Tracker</h3>

      <!-- Filters -->
      <form id="filters" class="grid" style="grid-template-columns: repeat(4, minmax(0, 1fr)); gap:.8rem; align-items:end;">
        <label><span data-i18n="filters.year">Year</span>
          <!-- <select id="year">
            <option value="2025/2026">2025/26</option>
            <option value="2024/25">2024/25</option>
            <option value="2023/24">2023/24</option>
            <option value="2022/23">2022/23</option>
            <option value="2021/22">2021/22</option>
            <option value="2020/21">2020/21</option>
            <option value="2019/20">2019/20</option>
            <option value="2018/19">2018/19</option> -->
            <select id="budget-year" class="border rounded px-2 py-1">
        <option>2025/26</option><option>2024/25</option><option>2023/24</option>
        <option>2022/23</option><option>2021/22</option><option>2020/21</option>
        <option>2019/20</option><option>2018/19</option><option> 2017/18</option>
          </select>
        </label>
        <label><span data-i18n="filters.sector">Sector</span>
          <select id="sector">
            <option data-i18n="filters.allSectors">All sectors</option>
            <option>Health</option><option>Education</option><option>Infrastructure</option><option>Agriculture</option>
            <option>Water & Sanitation</option><option>Transport</option><option>Energy</option>
            <option>Security</option><option>Governance</option><option>Environment</option>
            <option>Trade & Industry</option><option>Tourism</option><option>Youth Affairs</option><option>Gender & Social Services</option>
          </select>
        </label>
        <label><span data-i18n="filters.county">County</span>
          <select id="county">
            <option data-i18n="filters.allCounties">All counties</option>
            <option value="baringo">Baringo</option>
            <option value="bomet">Bomet</option>
            <option value="bungoma">Bungoma</option>
            <option value="busia">Busia</option>
            <option value="elgeyo-marakwet">Elgeyo-Marakwet</option>
            <option value="embu">Embu</option>
            <option value="garissa">Garissa</option>
            <option value="homa-bay">Homa Bay</option>
            <option value="isiolo">Isiolo</option>
            <option value="kajiado">Kajiado</option>
            <option value="kakamega">Kakamega</option>
            <option value="kericho">Kericho</option>
            <option value="kiambu">Kiambu</option>
            <option value="kilifi">Kilifi</option>
            <option value="kirinyaga">Kirinyaga</option>
            <option value="kisii">Kisii</option>
            <option value="kisumu">Kisumu</option>
            <option value="kitui">Kitui</option>
            <option value="kwale">Kwale</option>
            <option value="laikipia">Laikipia</option>
            <option value="lamu">Lamu</option>
            <option value="machakos">Machakos</option>
            <option value="makueni">Makueni</option>
            <option value="mandera">Mandera</option>
            <option value="marsabit">Marsabit</option>
            <option value="meru">Meru</option>
            <option value="migori">Migori</option>
            <option value="mombasa">Mombasa</option>
            <option value="muranga">Murang'a</option>
            <option value="nairobi">Nairobi</option>
            <option value="nakuru">Nakuru</option>
            <option value="nandi">Nandi</option>
            <option value="narok">Narok</option>
            <option value="nyamira">Nyamira</option>
            <option value="nyandarua">Nyandarua</option>
            <option value="nyeri">Nyeri</option>
            <option value="samburu">Samburu</option>
            <option value="siaya">Siaya</option>
            <option value="taita-taveta">Taita-Taveta</option>
            <option value="tana-river">Tana River</option>
            <option value="tharaka-nithi">Tharaka-Nithi</option>
            <option value="trans-nzoia">Trans Nzoia</option>
            <option value="turkana">Turkana</option>
            <option value="uasin-gishu">Uasin Gishu</option>
            <option value="vihiga">Vihiga</option>
            <option value="wajir">Wajir</option>
            <option value="west-pokot">West Pokot</option>
          </select>
        </label>
        <button type="button" id="update" class="btn" data-i18n="filters.update">Update Data</button>
      </form>

      <!-- Charts -->
      <div class="grid grid-2" style="margin-top:1rem;">
        <div class="chart-wrap">
          <div class="panel-title" data-i18n="chart.pieTitle">Budget Allocation by Sector</div>
          <div class="chart-box"><canvas id="pie"></canvas></div>
          <div id="pie-legend" class="legend" aria-live="polite"></div>
        </div>
        <div class="chart-wrap">
          <div class="panel-title" data-i18n="chart.barTitle">Planned vs Actual — Quarterly</div>
          <div class="chart-box"><canvas id="bars"></canvas></div>
          <p class="muted" style="margin:.3rem 0 0;" data-i18n="chart.tip">Tip: Tap a legend item to hide/show a series.</p>
        </div>
      </div>

      <!-- Summary Cards -->
      <div class="grid grid-3" style="margin-top:1rem;">
        <div class="card" style="text-align:center;">
          <div id="total-budget" style="font-size:1.6rem; font-weight:900; color:var(--kenya-green)">KSh 3.32T</div>
          <div class="mute" data-i18n="sum.totalBudget">Total Budget (selected)</div>
        </div>
        <div class="card" style="text-align:center;">
          <div id="total-spent" style="font-size:1.6rem; font-weight:900; color:var(--kenya-red)">KSh 2.10T</div>
          <div class="mute" data-i18n="sum.totalSpent">Total Spent (~63%)</div>
        </div>
        <div class="card" style="text-align:center;">
          <div id="pending-budget" style="font-size:1.6rem; font-weight:900; color:var(--kenya-green)">KSh 1.22T</div>
          <div class="mute" data-i18n="sum.pending">Pending (~37%)</div>
        </div>
      </div>

      <p class="mute" style="margin-top:.5rem;" data-i18n="sources.note">Data sources: National Treasury, Controller of Budget, County Budgets (demo data shown).</p>
    </div>
  </section>

  <!-- ===== OPEN CONTRACTING PORTAL ===== -->
  <section id="open-contracting" aria-labelledby="contracts-title" style="margin-top:.5rem;">
    <div class="container">
      <h3 id="contracts-title" class="panel-title" style="font-size:1.6rem;" data-i18n="contracts.title">Open Contracting Portal</h3>
      <form role="search" class="grid" style="grid-template-columns: 1fr auto; gap:.6rem;">
        <label><span data-i18n="contracts.search">Search</span>
          <input type="search" name="q" placeholder="Project, contractor, tender ID" aria-label="Search contracts" />
        </label>
        <button class="btn" type="button" data-i18n="contracts.filter">Filter</button>
      </form>

      <div style="overflow:auto; margin-top:1rem;">
        <table aria-describedby="contracts-help">
          <caption id="contracts-help" class="mute" data-i18n="contracts.caption">Browse, sort, and flag contracts. (Sample structure)</caption>
          <thead>
            <tr>
              <th scope="col" data-i18n="contracts.tender">Tender ID</th>
              <th scope="col" data-i18n="contracts.project">Project</th>
              <th scope="col" data-i18n="contracts.contractor">Contractor</th>
              <th scope="col" data-i18n="contracts.award">Award Value (KSh)</th>
              <th scope="col" data-i18n="contracts.date">Award Date</th>
              <th scope="col" data-i18n="contracts.status">Status</th>
              <th scope="col" data-i18n="contracts.flags">Flags</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>PPIP-001</td>
              <td>Nairobi Ward Road Upgrade</td>
              <td>ABC Builders Ltd</td>
              <td>120,000,000</td>
              <td>2025-07-10</td>
              <td><span class="badge" data-status="ongoing" data-i18n="status.ongoing">Ongoing</span></td>
              <td><a href="#" style="color:var(--kenya-red); font-weight:700;" data-i18n="contracts.report">Report</a></td>
            </tr>
            <tr>
              <td>PPIP-002</td>
              <td>County Hospital Wing</td>
              <td>HealthWorks KE</td>
              <td>340,000,000</td>
              <td>2025-06-02</td>
              <td><span class="badge" data-status="awarded" data-i18n="status.awarded">Awarded</span></td>
              <td><a href="#" style="color:var(--kenya-red); font-weight:700;" data-i18n="contracts.report">Report</a></td>
            </tr>
            <tr>
              <td>PPIP-003</td>
              <td>Garissa Solar Mini-Grid Phase 1</td>
              <td>SunGrid Africa</td>
              <td>210,000,000</td>
              <td>2025-05-18</td>
              <td><span class="badge" data-status="ongoing" data-i18n="status.ongoing">Ongoing</span></td>
              <td><a href="#" style="color:var(--kenya-red); font-weight:700;" data-i18n="contracts.report">Report</a></td>
            </tr>
            <tr>
              <td>PPIP-004</td>
              <td>Kiambu Community Water Project</td>
              <td>AquaWorks Consortium</td>
              <td>85,000,000</td>
              <td>2025-04-11</td>
              <td><span class="badge" data-status="awarded" data-i18n="status.awarded">Awarded</span></td>
              <td><a href="#" style="color:var(--kenya-red); font-weight:700;" data-i18n="contracts.report">Report</a></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- ===== PROJECT MONITORING ===== -->
  <section id="projects" aria-labelledby="projects-title">
    <div class="container">
      <h3 id="projects-title" class="panel-title" style="font-size:1.6rem;" data-i18n="projects.title">Project Monitoring</h3>
      <div class="grid grid-2">
        <div class="card" aria-label="Interactive map">
          <div id="map" role="application" aria-label="Project locations map"></div>
        </div>
        <div class="grid grid-2">
          <article class="card">
            <h4 style="color:var(--kenya-red); margin:0 0 .25rem;">Nakuru Dispensary</h4>
            <p class="mute" style="margin:.2rem 0 .4rem;">Health • Nakuru Town East</p>
            <p><strong>Budget:</strong> KSh 45M • <strong>Spent:</strong> KSh 20M</p>
            <label>Completion: <progress value="45" max="100">45%</progress></label>
            <details style="margin-top:.5rem;">
              <summary data-i18n="projects.updates">Updates</summary>
              <ul>
                <li>2025-08-01: Foundation complete (photo pending)</li>
                <li>2025-07-15: Contractor mobilized</li>
              </ul>
            </details>
          </article>
          <article class="card">
            <h4 style="color:var(--kenya-red); margin:0 0 .25rem;">Kisumu Road Upgrade</h4>
            <p class="mute" style="margin:.2rem 0 .4rem;">Roads • Kisumu Central</p>
            <p><strong>Budget:</strong> KSh 120M • <strong>Spent:</strong> KSh 90M</p>
            <label>Completion: <progress value="70" max="100">70%</progress></label>
            <details style="margin-top:.5rem;">
              <summary data-i18n="projects.updates">Updates</summary>
              <ul>
                <li>2025-08-10: Works slowed — awaiting materials</li>
                <li>2025-07-20: Drainage installed</li>
              </ul>
            </details>
          </article>
        </div>
      </div>
    </div>
  </section>

  <!-- ===== VIRTUAL BARAZAS: VIEW-ONLY ===== -->
  <section id="barazas-section" aria-labelledby="barazas-title">
    <div class="container">
      <h3 id="barazas-title" class="panel-title" data-i18n="barazas.title">Virtual Barazas — Upcoming Townhalls</h3>
      <p class="small-muted" data-i18n="barazas.text">
        Upcoming public barazas scheduled by community organizers. 
        Click <strong>Join</strong> to open the live meeting, or watch the <strong>Recording</strong> if you missed it. 
        Upvote or downvote to share feedback.
      </p>

      <div class="card" style="margin-top:.5rem;">
        <div class="baraza-controls">
          <label style="flex:2 1 240px; display:flex; flex-direction:column; gap:.3rem;">
            <span>Search</span>
            <input type="search" id="bz-search" placeholder="Search title, host, county, tags" />
          </label>
          <label style="flex:1 1 160px; display:flex; flex-direction:column; gap:.3rem;">
            <span>County</span>
            <select id="bz-county">
              <option value="">All</option>
              <option value="Nairobi">Nairobi</option>
              <option value="Kiambu">Kiambu</option>
              <option value="Nakuru">Nakuru</option>
              <option value="Kisumu">Kisumu</option>
              <option value="Mombasa">Mombasa</option>
            </select>
          </label>
          <!-- <label style="flex:1 1 160px; display:flex; flex-direction:column; gap:.3rem;">
            <span>From</span>
            <input type="date" id="bz-from" />
          </label>
          <label style="flex:1 1 160px; display:flex; flex-direction:column; gap:.3rem;">
            <span>To</span>
            <input type="date" id="bz-to" />
          </label>
          <label style="flex:1 1 160px; display:flex; flex-direction:column; gap:.3rem;">
            <span>Sort</span> -->
            <!-- <select id="bz-sort"> -->
              <!-- <option value="time">Start time</option> -->
              <!-- <option value="popularity">Popularity</option> -->
            <!-- </select> -->
          </label>
        </div>
        <div class="tabs" style="margin-top:.5rem;">
          <button class="tab-btn active" data-tab="upcoming">Upcoming</button>
          <button class="tab-btn" data-tab="past">Past</button>
        </div>
      </div>

      <div id="baraza-container" style="margin-top:12px">
        <div class="card">
          <div class="small-muted">Loading upcoming barazas…</div>
        </div>
      </div>
    </div>
  </section>

  <!-- Modal for embedded meeting -->
  <div id="baraza-overlay" class="overlay" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="toolbar">
        <div>
          <strong id="modal-title" style="color:#fff">Meeting</strong>
          <div id="modal-meta" style="color:#fff;font-size:0.95rem"></div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="copy-link" class="copy-btn">Copy Link</button>
          <button id="modal-close" class="close-x" aria-label="Close">✕</button>
        </div>
      </div>
      <div class="iframe-wrap" id="modal-iframe"></div>
    </div>
  </div>


  <!-- ===== REPORT ===== -->
  <section id="report" aria-labelledby="report-title">
    <div class="container">
      <h3 id="report-title" class="panel-title" style="font-size:1.6rem;" data-i18n="report.title">Report an Issue</h3>
      <p class="mute" data-i18n="report.help">Report delays, ghost projects, or misuse of funds. A tracking ID will be generated.</p>
      <form class="grid grid-2">
        <label><span data-i18n="report.project">Project (link or name)</span>
          <input type="text" name="project" placeholder="e.g., Nakuru Dispensary" />
        </label>
        <label><span data-i18n="report.location">Location</span>
          <input type="text" name="location" placeholder="County / Ward" />
        </label>
        <label><span data-i18n="report.issueType">Issue Type</span>
          <select name="issue">
            <option data-i18n="issue.delay">Delay</option>
            <option data-i18n="issue.abandoned">Abandoned site</option>
            <option data-i18n="issue.quality">Quality concern</option>
            <option data-i18n="issue.corruption">Corruption / Irregularity</option>
          </select>
        </label>
        <label><span data-i18n="report.details">Details</span>
          <textarea name="details" rows="5" placeholder="Describe the issue…"></textarea>
        </label>
        <label><span data-i18n="report.photo">Upload Photo (optional)</span>
          <input type="file" name="photo" accept="image/*" />
        </label>
        <label><span data-i18n="report.phone">Phone (optional for follow-up)</span>
          <input type="tel" name="phone" placeholder="07xx xxx xxx" />
        </label>
        <label style="flex-direction:row; align-items:center; gap:.5rem;">
          <input type="checkbox" name="consent" /> <span data-i18n="report.consent">I consent to share this information for accountability purposes.</span>
        </label>
        <div><button type="submit" class="btn" data-i18n="report.submit">Submit Report</button></div>
      </form>
    </div>
  </section>

<!-- ===== USSD & WHATSAPP ===== -->
  <section id="channels" aria-labelledby="channels-title" style="margin-top:.5rem;">
    <div class="container">
      <h3 id="channels-title" class="panel-title" style="font-size:1.6rem;" data-i18n="channels.title">USSD & WhatsApp Chatbot</h3>
      <div class="channels">
        <!-- USSD -->
        <div class="channel ussd">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M2 3h20v14H6l-4 4V3zm2 2v12.17L6.17 15H20V5H4zm10 2h2v6h-2V7zm-6 0h2v6H8V7z"/></svg>
          <div>
            <div class="big" data-i18n="channels.ussdDial">Dial <span style="color:var(--kenya-green)">*</span><span>384</span><span>*43258#</span></div>
            <div class="mute" data-i18n="channels.ussdText">Check budgets, projects, and report issues from any phone.</div>
            <div style="margin-top:.5rem;">
              <button class="btn" type="button" onclick="alert('This is a demo. On a real phone, you would dial *384*43258#.');" data-i18n="channels.how">How it works</button>
            </div>
          </div>
        </div>
        <!-- WhatsApp -->
        <div class="channel whatsapp">
          <svg viewBox="0 0 32 32" aria-hidden="true"><path fill="#25D366" d="M16 .6C7.6.6.8 7.4.8 15.8c0 2.7.7 5.2 2.1 7.4L.6 31.4l8.4-2.2c2.1 1.1 4.5 1.7 7 1.7 8.4 0 15.2-6.8 15.2-15.2S24.4.6 16 .6z"/><path fill="#fff" d="M24 19.6c-.4 1.1-2.1 2-2.9 2.1-.8.1-1.7.2-2.8-.2-3.1-1-5-3.5-5.1-3.7-.1-.1-1.2-1.6-1.2-3.1s.7-2.2 1-2.5c.4-.5.9-.6 1.2-.6h.9c.3 0 .7 0 1 .8.4.9 1.3 3.2 1.4 3.4.1.2.1.4 0 .6-.2.5-.5.9-.9 1.4-.2.2-.4.4-.2.8.2.4 1 1.6 2.2 2.6 1.5 1.3 2.8 1.7 3.3 1.9.4.2.7.2 1-.1.3-.3 1.2-1.4 1.5-1.8.3-.4.6-.4 1-.2l2.3 1.1c.5.2.8.4.9.6.1.2.1 1.3-.3 2.3z"/></svg>
          <div>
            <div class="big" data-i18n="channels.wa">Open Chat: <a href="https://wa.me/254721606409?text=Hello%20WaziHub" target="" rel="noopener" class="btn" style="--bg:#25D366;" data-i18n="channels.openChat">Open Chat</a></div>
            <div class="mute" data-i18n="channels.waText">Save <strong>+254 721606409</strong> then say “Hello WaziHub”.</div>
            <a href="https://wa.me/254721606409?text=Hello%20WaziHub" class="btn">Chat on WhatsApp</a> 
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- ===== ABOUT / FOOTER ===== -->
  <section id="about" aria-labelledby="about-title">
    <div class="container">
      <h3 id="about-title" class="panel-title" style="font-size:1.6rem;" data-i18n="about.title">About WaziHub</h3>
      <p data-i18n="about.text">WaziHub is a Kenyan civic tech platform for budget transparency, open contracting, project monitoring, and citizen feedback. Built with the community, for the community.</p>
    </div>
  </section>

  <footer role="contentinfo">
    <div class="container">
      <p><strong>WaziHub</strong> — <span data-i18n="brand.tag">See More • Know More • Do More</span>.</p>
      <nav aria-label="Footer">
        <ul class="flex" style="flex-wrap:wrap;">
          <li><a href="#channels" data-i18n="nav.channels">USSD & WhatsApp</a></li>
          <li><a href="#sources" data-i18n="footer.sources">Data Sources</a></li>
          <li><a href="#privacy" data-i18n="footer.privacy">Privacy</a></li>
          <li><a href="#faq" data-i18n="footer.faq">FAQs</a></li>
        </ul>
      </nav>
      <p class="muted">© <span id="year">2025</span> WaziHub. All rights reserved.</p>
    </div>
  </footer>
</main>

<script>
  // ===== FOOTER YEAR =====
  document.getElementById('year').textContent = new Date().getFullYear();

  // ===== FORMATTER =====
  const fmt = (n) => {
    if (n >= 1e12) return "KSh " + (n/1e12).toFixed(2) + "T";
    if (n >= 1e9)  return "KSh " + (n/1e9).toFixed(2) + "B";
    if (n >= 1e6)  return "KSh " + (n/1e6).toFixed(2) + "M";
    return "KSh " + n.toLocaleString();
  };

  // ===== LANGUAGE: STRINGS =====
  const STR = {
    en: {
      "brand.name":"Wazi Hub","brand.tag":"See More • Know More • Do More",
      "nav.home":"Home","nav.budgets":"Budgets","nav.contracts":"Contracts","nav.projects":"Projects","nav.channels":"USSD & WhatsApp","nav.report":"Report","nav.about":"About",
      "nav.barazas":"Barazas",
      "hero.title":"See More. Know More. Do More.",
      "hero.text":"Track budgets, monitor projects, follow contracts, and hold leaders accountable — all in one easy dashboard built for everyone in Kenya.",
      "cta.budgets":"Explore Budgets","cta.contracts":"Open Contracting","cta.report":"Report an Issue",
      "hl.title":"Highlights","hl.a.title":"Where is your county’s money going?","hl.a.text":"Quick view of allocations by sector for your county.",
      "hl.b.title":"Who won the latest tenders?","hl.b.text":"Search contractors, awards, and red flags.",
      "hl.c.title":"Is that road really 80% complete?","hl.c.text":"Project statuses, photos, and community updates.",
      "lang.label":"Language / Lugha:","lang.beta":"Translation (Beta)","lang.apply":"Apply",
      "budget.title":"Open Budget Tracker",
      "filters.year":"Year","filters.sector":"Sector","filters.county":"County","filters.allSectors":"All sectors","filters.allCounties":"All counties","filters.update":"Update Data",
      "chart.pieTitle":"Budget Allocation by Sector","chart.barTitle":"Planned vs Actual — Quarterly","chart.tip":"Tip: Tap a legend item to hide/show a series.",
      "sum.totalBudget":"Total Budget (selected)","sum.totalSpent":"Total Spent (~63%)","sum.pending":"Pending (~37%)",
      "sources.note":"Data sources: National Treasury, Controller of Budget, County Budgets (demo data shown).",
      "contracts.title":"Open Contracting Portal","contracts.search":"Search","contracts.filter":"Filter","contracts.caption":"Browse, sort, and flag contracts. (Sample structure)","contracts.tender":"Tender ID","contracts.project":"Project","contracts.contractor":"Contractor","contracts.award":"Award Value (KSh)","contracts.date":"Award Date","contracts.status":"Status","contracts.flags":"Flags","contracts.report":"Report",
      "status.ongoing":"Ongoing","status.awarded":"Awarded",
      "projects.title":"Project Monitoring","projects.updates":"Updates",
      "channels.title":"USSD & WhatsApp Chatbot","channels.ussdDial":"Dial *384*43258#","channels.ussdText":"Check budgets, projects, and report issues from any phone.","channels.how":"How it works","channels.wa":"Chat on WhatsApp:","channels.openChat":"Open Chat","channels.waText":"Save +254 700 000 000 then say “Hello Wazi”.",
      "barazas.title":"Virtual Barazas — Upcoming Townhalls","barazas.text":"Upcoming public barazas scheduled by community organizers. Click Join to open the live meeting, or watch the Recording if you missed it. Upvote or downvote to share feedback.",
      "report.title":"Report an Issue","report.help":"Report delays, ghost projects, or misuse of funds. A tracking ID will be generated.","report.project":"Project (link or name)","report.location":"Location","report.issueType":"Issue Type","report.details":"Details","report.photo":"Upload Photo (optional)","report.phone":"Phone (optional for follow-up)","report.consent":"I consent to share this information for accountability purposes.","report.submit":"Submit Report",
      "about.title":"About Wazi Hub","about.text":"Wazi Hub is a Kenyan civic tech platform for budget transparency, open contracting, project monitoring, and citizen feedback. Built with the community, for the community.",
      "footer.sources":"Data Sources","footer.privacy":"Privacy","footer.faq":"FAQs"
    },
    sw: { // Kiswahili
      "brand.name":"Wazi Hub","brand.tag":"Ona Zaidi • Fahamu Zaidi • Fanya Zaidi",
      "nav.home":"Nyumbani","nav.budgets":"Bajeti","nav.contracts":"Mikataba","nav.projects":"Miradi","nav.channels":"USSD & WhatsApp","nav.report":"Ripoti","nav.about":"Kuhusu","nav.barazas":"Baraza",
      "hero.title":"Ona Zaidi. Fahamu Zaidi. Fanya Zaidi.",
      "hero.text":"Fuatilia bajeti, fuatilia miradi, angalia mikataba, na wawajibishe viongozi — kwenye dashibodi rahisi kwa wote nchini Kenya.",
      "cta.budgets":"Chunguza Bajeti","cta.contracts":"Uwazi wa Ununuzi","cta.report":"Toa Taarifa",
      "hl.title":"Mambo Muhimu","hl.a.title":"Fedha za kaunti yako zinaenda wapi?","hl.a.text":"Muhtasari wa mgao kwa sekta katika kaunti yako.",
      "hl.b.title":"Nani alipata zabuni za karibuni?","hl.b.text":"Tafuta wakandarasi, tuzo na viashiria hatarishi.",
      "hl.c.title":"Je, barabara hiyo imekamilika 80% kweli?","hl.c.text":"Hali ya miradi, picha na taarifa za jamii.",
      "lang.label":"Lugha:","lang.beta":"Tafsiri (Beta)","lang.apply":"Tumia",
      "budget.title":"Kifuatiliaji cha Bajeti",
      "filters.year":"Mwaka","filters.sector":"Sekta","filters.county":"Kaunti","filters.allSectors":"Sekta zote","filters.allCounties":"Kaunti zote","filters.update":"Sasisha Data",
      "chart.pieTitle":"Mgao wa Bajeti kwa Sekta","chart.barTitle":"Zilizopangwa dhidi ya Halisi — Robo Mwaka","chart.tip":"Kidokezo: Gonga katika hadithi kuficha/kuonyesha mfululizo.",
      "sum.totalBudget":"Jumla ya Bajeti (zilizochaguliwa)","sum.totalSpent":"Jumla Iliyotumika (~63%)","sum.pending":"Bado (~37%)",
      "sources.note":"Vyanzo: Hazina ya Taifa, Mdhibiti wa Bajeti, Bajeti za Kaunti (data ya mfano).",
      "contracts.title":"Kituo cha Ununuzi Wazi","contracts.search":"Tafuta","contracts.filter":"Chuja","contracts.caption":"Vinjari, panga na weka alama mikataba. (Mfano)","contracts.tender":"Nambari ya Zabuni","contracts.project":"Mradi","contracts.contractor":"Mkandarasi","contracts.award":"Thamani ya Tuzo (KSh)","contracts.date":"Tarehe ya Tuzo","contracts.status":"Hali","contracts.flags":"Alama","contracts.report":"Ripoti",
      "status.ongoing":"Inaendelea","status.awarded":"Imetunukiwa",
      "projects.title":"Ufuatiliaji wa Miradi","projects.updates":"Taarifa",
      "channels.title":"USSD & WhatsApp Chatbot","channels.ussdDial":"Piga *384*43258#","channels.ussdText":"Angalia bajeti, miradi, na toa taarifa kwa simu yoyote.","channels.how":"Jinsi inavyofanya kazi","channels.wa":"Soga WhatsApp:","channels.openChat":"Fungua Mazungumzo","channels.waText":"Hifadhi +254 700 000 000 kisha sema “Hello Wazi”.",
      "barazas.title":"Baraza za Mitandaoni — Mikutano Ijayo","barazas.text":"Baraza za umma zijazo zimepangwa na waandaaji wa jamii. Bonyeza Jiunge kufungua kikao, au tazama Rekodi ikiwa ulilikosa. Piga kura juu au chini kutoa maoni.",
      "report.title":"Toa Taarifa","report.help":"Ripoti ucheleweshaji, miradi hewa au matumizi mabaya ya fedha. Utapata nambari ya ufuatiliaji.","report.project":"Mradi (kiungo au jina)","report.location":"Eneo","report.issueType":"Aina ya Tatizo","report.details":"Maelezo","report.photo":"Pakia Picha (hiari)","report.phone":"Simu (hiari kwa ufuatiliaji)","report.consent":"Ninakubali kushiriki taarifa hizi kwa uwajibikaji.","report.submit":"Wasilisha",
      "about.title":"Kuhusu Wazi Hub","about.text":"Wazi Hub ni jukwaa la uwazi wa bajeti, ununuzi wazi, ufuatiliaji wa miradi na mrejesho wa wananchi.",
      "footer.sources":"Vyanzo vya Data","footer.privacy":"Faragha","footer.faq":"Maswali"
    },
    // Short community translations (concise; demo scope)
    ki: { "nav.home":"Mũciĩ","nav.budgets":"Bajeti","nav.contracts":"Mikataba","nav.projects":"Mĩtugo","nav.channels":"USSD & WhatsApp","nav.report":"Rĩpoti","nav.about":"Ũhoro",
          "hero.title":"Ona mĩgambo, mũtũgũrũka, kora gũkũ.","cta.budgets":"Tũrone Bajeti","budget.title":"Kĩgũrũkia Bajeti",
          "filters.year":"Mwaka","filters.sector":"Kĩanda","filters.county":"Kaũnti","filters.allSectors":"Ma-anda mothe","filters.allCounties":"Ma-kaũnti mothe","filters.update":"Hũthũria Data",
          "chart.pieTitle":"Kũgawio kwa Ma-anda","chart.barTitle":"Matarĩtũ na Ma-hĩndĩ — Rũbũ","projects.title":"Kũthungatira Mĩtugo",
          "report.title":"Rĩpoti ĩtua","channels.title":"USSD & WhatsApp"}
    ,
    luo: {"nav.home":"Od bura","nav.budgets":"Budget","nav.contracts":"Kondract","nav.projects":"Projek","nav.report":"Ripoti","hero.title":"Neno Mabor. Ng’eyo Mabor. Timo Mabor.","cta.budgets":"Nen Budget","budget.title":"Lonyo Budget","filters.year":"Higa","filters.sector":"Secta","filters.county":"County","filters.update":"Yik Data","chart.pieTitle":"Goyo Budget gi Secta","chart.barTitle":"Ma oseyie gi Ma timore — Quarter","projects.title":"Timo Neno Projek"},
    kamba: {"nav.home":"Mũkaũ","cta.budgets":"Yona Bajeti","budget.title":"Kiw’ang’a kya Bajeti","filters.year":"Muaka","filters.sector":"Sekta","filters.county":"Kaunti","filters.update":"Sasya Data","chart.pieTitle":"Utethyo wa Bajeti kwa Sekta","chart.barTitle":"Ila Syaikite na Ila Syaikw’ata — Kwetani"},
    luy: {"nav.home":"Ing’anda","filters.year":"Omwaka","filters.sector":"Omusekta","filters.county":"County","filters.update":"Sasula Data","budget.title":"Sikuli ya Budget"},
    kal: {"budget.title":"Budgetit ne Imet","filters.year":"Met","filters.sector":"Sekta","filters.county":"County","filters.update":"Tayin Data","chart.pieTitle":"Tugul Budget ko Setkait"},
    som: {"nav.home":"Guri","budget.title":"Dabagalka Miisaaniyadda","filters.year":"Sannad","filters.sector":"Qeyb","filters.county":"County","filters.update":"Cusbooneysii","chart.pieTitle":"Qeybinta Miisaaniyadda"},
    tuk: {"nav.home":"Akirok","budget.title":"Budget Akirok","filters.year":"Akur","filters.sector":"Ngakipi","filters.county":"County","filters.update":"Akosi Data"},
    meru: {"nav.home":"Mucee","budget.title":"Kĩgwatĩria Kĩa Budget","filters.year":"Mwaka","filters.sector":"Sekita","filters.county":"Kaunti","filters.update":"Tigithia Data"}
  };

  function translateContent(lang){
    const dict = STR[lang] || STR.en;
    document.querySelectorAll('[data-i18n]').forEach(el=>{
      const key = el.getAttribute('data-i18n');
      if(dict[key]) el.textContent = dict[key];
    });
    localStorage.setItem('wazi-lang', lang);
  }

  // Apply stored language on load
  const storedLang = localStorage.getItem('wazi-lang') || 'en';
  document.getElementById('language-select').value = storedLang;
  translateContent(storedLang);
  document.getElementById('apply-lang').addEventListener('click', ()=>{
    const lang = document.getElementById('language-select').value;
    translateContent(lang);
  });

  // ===== DEMO BUDGET DATA (by sector; base) =====
  const sectorPalette = {
    "Health":"#ff6b35","Education":"#f7931e","Infrastructure":"#ffd23f","Agriculture":"#06d6a0",
    "Water & Sanitation":"#118ab2","Security":"#073b4c","Transport":"#7209b7","Energy":"#aacc00",
    "Governance":"#f94144","Environment":"#2a9d8f","Trade & Industry":"#f3722c","Tourism":"#43aa8b",
    "Youth Affairs":"#577590","Gender & Social Services":"#f8961e"
  };

  const baseData = {
    "Health":{planned: 850e9, actual: 720e9},
    "Education":{planned: 920e9, actual: 850e9},
    "Infrastructure":{planned: 680e9, actual: 450e9},
    "Agriculture":{planned: 320e9, actual: 280e9},
    "Water & Sanitation":{planned: 280e9, actual: 230e9},
    "Security":{planned: 450e9, actual: 420e9},
    "Transport":{planned: 390e9, actual: 310e9},
    "Energy":{planned: 260e9, actual: 210e9},
    "Governance":{planned: 150e9, actual: 120e9},
    "Environment":{planned: 95e9, actual: 80e9},
    "Trade & Industry":{planned: 110e9, actual: 90e9},
    "Tourism":{planned: 70e9, actual: 52e9},
    "Youth Affairs":{planned: 55e9, actual: 40e9},
    "Gender & Social Services":{planned: 60e9, actual: 48e9}
  };

  // Year multipliers (dummy)
  const yearMul = {
    "2025/26":1.06,"2024/25":1.00,"2023/24":0.96,"2022/23":0.92,"2021/22":0.90,"2020/21":0.88,"2019/20":0.86,"2018/19":0.82
  };

  // County scalers (dummy; larger for some)
  const countyScale = {
    default: 1.0, nairobi: 1.25, nakuru: 1.12, kiambu: 1.1, mombasa: 1.08, kakamega:1.06, kisumu:1.05
  };

  // ===== CHARTS =====
  const pieCtx = document.getElementById('pie').getContext('2d');
  const barCtx = document.getElementById('bars').getContext('2d');
  let pieChart, barChart;

  function makePie(data){
    const labels = Object.keys(data);
    const values = labels.map(k => data[k].planned);
    const colors = labels.map(l => sectorPalette[l] || '#ccc');
    return new Chart(pieCtx, {
      type: 'pie',
      data: { labels, datasets: [{ data: values, backgroundColor: colors, borderColor: '#ffffff', borderWidth: 2 }]},
      options: {
        plugins:{
          legend:{ display:false },
          tooltip:{ callbacks:{ label:(ctx)=> `${ctx.label}: ${fmt(ctx.parsed)}` } }
        }
      }
    });
  }

  function makeBars(data){
    const labels = ["Q1","Q2","Q3","Q4"];
    const plannedTotal = Object.values(data).reduce((s,v)=>s+v.planned,0);
    const actualTotal  = Object.values(data).reduce((s,v)=>s+v.actual,0);
    // Simple quarterly splits (dummy)
    const p = [0.24,0.26,0.26,0.24].map(r=> Math.round(plannedTotal*r));
    const a = [0.20,0.23,0.25,0.22].map((r,i)=> Math.min(Math.round(actualTotal*r), p[i])); // cap actual <= planned per quarter
    return new Chart(barCtx, {
      type:'bar',
      data:{
        labels,
        datasets:[
          { label:'Planned', data:p, backgroundColor:'rgba(0,133,63,0.85)' },
          { label:'Actual',  data:a, backgroundColor:'rgba(187,25,25,0.9)' }
        ]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        layout:{ padding:{ top: 8, right: 8, bottom: 0, left: 8 } },
        plugins:{
          legend:{ position:'top', labels:{ boxWidth: 12, boxHeight:12, padding:10 } },
          tooltip:{ padding:8 }
        },
        interaction:{ mode:'index', intersect:false },
        scales:{
          y:{ beginAtZero:true, grace:'1%', ticks:{ callback:(v)=> (v/1e9)+'B' } },
          x:{ grid:{ display:false } }
        }
      }
    });
  }

  function buildLegend(data){
    const el = document.getElementById('pie-legend');
    el.innerHTML = '';
    for(const [label,vals] of Object.entries(data)){
      const color = sectorPalette[label] || '#ccc';
      const item = document.createElement('div');
      item.innerHTML = `<span style="display:inline-block;width:14px;height:14px;border-radius:3px;background:${color};margin-right:8px;vertical-align:middle;"></span>${label} — <strong>${fmt(vals.planned)}</strong>`;
      el.appendChild(item);
    }
  }

  function updateCards(data){
    const planned = Object.values(data).reduce((s,v)=>s+v.planned,0);
    const actual  = Object.values(data).reduce((s,v)=>s+v.actual,0);
    const pending = Math.max(planned-actual, 0);
    document.getElementById('total-budget').textContent = fmt(planned);
    document.getElementById('total-spent').textContent  = fmt(actual);
    document.getElementById('pending-budget').textContent = fmt(pending);
  }

  function filterBySector(data, sector){
    if(!sector || sector==="All sectors" || sector==="Sekta zote" || sector==="Sekta zote") return data;
    const filtered = {};
    if(data[sector]) filtered[sector] = data[sector];
    return filtered;
  }

  function scaleForCounty(data, countyVal){
    const key = (countyVal||'').toLowerCase();
    const scale = countyScale[key] || countyScale.default;
    const scaled = {};
    for(const k in data){
      scaled[k] = {
        planned: Math.round(data[k].planned*scale),
        actual : Math.round(data[k].actual *Math.min(scale, 1.15))
      };
    }
    return scaled;
  }

  function scaleForYear(data, year){
    const mul = yearMul[year] || 1;
    const scaled = {};
    for(const k in data){
      scaled[k] = {
        planned: Math.round(data[k].planned*mul),
        actual : Math.round(data[k].actual *mul*0.97) // slight execution gap
      };
    }
    return scaled;
  }

  function drawAll(){
    const sectorSel = document.getElementById('sector').value;
    const countySel = document.getElementById('county').value;
    const yearSel   = document.getElementById('year').value;
    let data = scaleForYear(baseData, yearSel);
    data = scaleForCounty(data, countySel);
    data = filterBySector(data, sectorSel);

    if(pieChart) pieChart.destroy();
    if(barChart) barChart.destroy();

    pieChart = makePie(data);
    barChart = makeBars(data);
    buildLegend(data);
    updateCards(data);
  }

  document.getElementById('update').addEventListener('click', drawAll);

  // Initial charts render
  drawAll();

  // ===== MAP: DUMMY PROJECT PINS =====
  // Map centered roughly on Kenya
  const map = L.map('map', {
    zoomControl: true,
    scrollWheelZoom: false,
    dragging: false,
    keyboard: false,
    tap: false
  }).setView([0.3, 37.8], 6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18, attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  const projects = [
    { name:"Nairobi Ward Road Upgrade", sector:"Transport", county:"Nairobi", lat:-1.286, lng:36.817, budget: 120e6, spent: 75e6, progress:62, status:"Ongoing" },
    { name:"Kisumu Waterfront Drainage", sector:"Water & Sanitation", county:"Kisumu", lat:-0.0917, lng:34.7680, budget: 90e6, spent: 60e6, progress:70, status:"Ongoing" },
    { name:"Mombasa Clinic Expansion", sector:"Health", county:"Mombasa", lat:-4.0435, lng:39.6682, budget: 65e6, spent: 58e6, progress:88, status:"Awarded" },
    { name:"Garissa Solar Mini-Grid", sector:"Energy", county:"Garissa", lat:-0.453, lng:39.646, budget: 150e6, spent: 40e6, progress:28, status:"Ongoing" },
    { name:"Nakuru Dispensary", sector:"Health", county:"Nakuru", lat:-0.3031, lng:36.0800, budget: 45e6, spent: 20e6, progress:45, status:"Ongoing" },
    { name:"Eldoret Agro Park", sector:"Agriculture", county:"Uasin Gishu", lat:0.5143, lng:35.2698, budget: 210e6, spent: 95e6, progress:41, status:"Ongoing" },
    { name:"Machakos ICT Hub", sector:"Governance", county:"Machakos", lat:-1.5177, lng:37.2634, budget: 80e6, spent: 30e6, progress:35, status:"Ongoing" },
    { name:"Nyeri Rural Water Scheme", sector:"Water & Sanitation", county:"Nyeri", lat:-0.4200, lng:36.9519, budget: 55e6, spent: 22e6, progress:33, status:"Ongoing" },
    { name:"Turkana Wind Trial Site", sector:"Energy", county:"Turkana", lat:3.1150, lng:35.5970, budget: 95e6, spent: 50e6, progress:52, status:"Ongoing" }
  ];

  projects.forEach(p=>{
    const popup = `
      <strong>${p.name}</strong><br/>
      <em>${p.sector} • ${p.county}</em><br/>
      <div>Budget: <strong>${fmt(p.budget)}</strong> &nbsp; • &nbsp; Spent: <strong>${fmt(p.spent)}</strong></div>
      <div>Status: <span class="badge" style="vertical-align:middle;">${p.status}</span></div>
      <div style="margin-top:.3rem;">Progress:
        <progress value="${p.progress}" max="100" style="width:100%">${p.progress}%</progress>
      </div>
    `;
    L.marker([p.lat,p.lng]).addTo(map).bindPopup(popup);
  });

  // Enable dragging only while pointer is over the map
  const mapEl = document.getElementById('map');
  mapEl.addEventListener('mouseenter', ()=> map.dragging.enable());
  mapEl.addEventListener('mouseleave', ()=> map.dragging.disable());
  // On touch, enable dragging for the duration of the interaction only
  mapEl.addEventListener('touchstart', ()=> map.dragging.enable(), {passive:true});
  mapEl.addEventListener('touchend',   ()=> map.dragging.disable());

  // ===== BARAZA LIST & MODAL =====
  const API_BASE = '/api';
  const BARAZAS_ENDPOINT = `${API_BASE}/barazas`;
  const VOTE_ENDPOINT = (id) => `${API_BASE}/barazas/${id}/vote`;

  const barazaContainer = document.getElementById('baraza-container');
  const overlay = document.getElementById('baraza-overlay');
  const modalIframe = document.getElementById('modal-iframe');
  const modalTitle = document.getElementById('modal-title');
  const modalMeta = document.getElementById('modal-meta');
  const copyLinkBtn = document.getElementById('copy-link');
  const modalClose = document.getElementById('modal-close');
  const bzSearch = document.getElementById('bz-search');
  const bzCounty = document.getElementById('bz-county');
  const bzFrom = document.getElementById('bz-from');
  const bzTo = document.getElementById('bz-to');
  const bzSort = document.getElementById('bz-sort');
  const tabButtons = Array.from(document.querySelectorAll('.tab-btn'));
  let activeTab = 'upcoming';
  let barazaList = [];

  // Topic -> recognizable venue mapping (expanded as needed)
  const TOPIC_LOCATION = {
    Health: 'Subcounty Hospital',
    Sanitation: 'Town Social Hall',
    Water: 'Water Board Offices',
    Education: 'Teachers Resource Centre',
    Budget: 'County Treasury Hall',
    Roads: 'Public Works Yard',
    Transport: 'Public Works Yard',
    Energy: 'County Power Offices',
    Agriculture: 'Agricultural Training Centre',
    Environment: 'Environmental Resource Centre',
    Governance: 'County Hall',
    Trade: 'Main Market Hall',
    Tourism: 'Tourism Info Centre',
    Youth: 'Youth Empowerment Centre',
    Gender: 'Social Services Hall',
    default: 'County Social Hall'
  };

  function pickLocation(county, tags){
    const tagList = Array.isArray(tags) ? tags : [];
    for(const t of tagList){
      const key = String(t||'').trim();
      if(TOPIC_LOCATION[key]) return `${county} ${TOPIC_LOCATION[key]}`;
    }
    return `${county} ${TOPIC_LOCATION.default}`;
  }

  async function loadBarazas(){
    try {
      const res = await fetch(BARAZAS_ENDPOINT);
      if(!res.ok) throw new Error();
      const data = await res.json();
      renderBarazas(data);
      barazaList = enrichBarazas(data);
      renderBarazas(applyBarazaFilters());
    } catch {
      // Fallback demo data
      renderBarazas([
        { id:1, title:"Community Sanitation Forum", county:"Nakuru Town East", datetime:new Date(Date.now()+3600*1000).toISOString(), meeting_link:"https://meet.jit.si/WaziHub-demo-1", recording_link:"", upvotes:12, downvotes:3 },
        { id:2, title:"Ward Education Baraza", county:"Kiambu Central", datetime:new Date(Date.now()+48*3600*1000).toISOString(), meeting_link:"https://meet.jit.si/WaziHub-demo-2", recording_link:"https://example.com/recording.mp4", upvotes:8, downvotes:1 }
      ]);
      barazaList = enrichBarazas([
        { id:1, title:"Community Sanitation Forum", county:"Nakuru", datetime:new Date(Date.now()+3600*1000).toISOString(), meeting_link:"https://meet.jit.si/WaziHub-demo-1", recording_link:"", upvotes:12, downvotes:3, host:"Public Health Dept.", participants:42, tags:["Health","Sanitation"], highlights: [] },
        { id:2, title:"Ward Education Baraza", county:"Kiambu", datetime:new Date(Date.now()+48*3600*1000).toISOString(), meeting_link:"https://meet.jit.si/WaziHub-demo-2", recording_link:"https://example.com/recording.mp4", upvotes:8, downvotes:1, host:"Ward Office", participants:18, tags:["Education","Budget"], highlights: [] },
        { id:3, title:"Kisumu Water Update", county:"Kisumu", datetime:new Date(Date.now()-26*3600*1000).toISOString(), meeting_link:"https://example.com/live-not-embed", recording_link:"https://example.com/water.mp4", upvotes:25, downvotes:2, host:"Water Board", participants:120, tags:["Water","Projects"], highlights: [
          { id:"h1", text:"Contractor committed to clear drainage by next week.", up:15, down:2 },
          { id:"h2", text:"Budget reallocation of KSh 10M to flood-prone wards.", up:22, down:1 },
          { id:"h3", text:"Community to share geotagged photos via WhatsApp line.", up:8, down:0 }
        ] }
      ]);
      renderBarazas(applyBarazaFilters());
    }
  }

  function enrichBarazas(data){
    return data.map((b)=>{
      const tags = Array.isArray(b.tags) ? b.tags : [];
      const county = b.county || '';
      const location = b.location || pickLocation(county, tags);
      return {
        ...b,
        tz: b.tz || Intl.DateTimeFormat().resolvedOptions().timeZone,
        popularity: (b.upvotes||0) - (b.downvotes||0) + (b.participants||0)/50,
        tags,
        host: b.host || 'Organizer',
        participants: Number.isFinite(b.participants) ? b.participants : Math.floor(20+Math.random()*80),
        location
      };
    });
  }

  function applyBarazaFilters(){
    const q = (bzSearch?.value||'').trim().toLowerCase();
    const c = (bzCounty?.value||'').trim().toLowerCase();
    const from = bzFrom?.value ? new Date(bzFrom.value).getTime() : -Infinity;
    const to = bzTo?.value ? new Date(bzTo.value).getTime()+24*3600*1000-1 : Infinity;
    const now = Date.now();
    let list = barazaList.filter(b=>{
      const t = new Date(b.datetime).getTime();
      if(activeTab==='upcoming' && t < now) return false;
      if(activeTab==='past' && t >= now) return false;
      if(c && (b.county||'').toLowerCase() !== c) return false;
      if(!(t>=from && t<=to)) return false;
      if(q){
        const hay = [b.title,b.host,b.county,(b.tags||[]).join(' ')].join(' ').toLowerCase();
        if(!hay.includes(q)) return false;
      }
      return true;
    });
    const sortBy = bzSort?.value || 'time';
    list.sort((a,b)=>{
      if(sortBy==='popularity') return (b.popularity||0) - (a.popularity||0);
      return new Date(a.datetime) - new Date(b.datetime);
    });
    return list;
  }

  function formatRelative(dt){
    const d = new Date(dt).getTime();
    const now = Date.now();
    const diff = d - now;
    const abs = Math.abs(diff);
    const rtf = new Intl.RelativeTimeFormat(undefined,{numeric:'auto'});
    const units = [
      ['day', 86400000],
      ['hour', 3600000],
      ['minute', 60000]
    ];
    for(const [unit, ms] of units){
      if(abs >= ms || unit==='minute'){
        return rtf.format(Math.round(diff/ms), unit);
      }
    }
  }

  // Live countdown update every 30s
  setInterval(()=>{
    document.querySelectorAll('#baraza-container .baraza-item').forEach(item=>{
      const id = item.dataset.id;
      const b = barazaList.find(x=>String(x.id)===String(id));
      if(!b) return;
      const line = item.querySelector('.baraza-datetime span');
      if(line) line.textContent = formatRelative(b.datetime);
      const meta = item.querySelector('.baraza-datetime');
      if(meta){
        const badges = getBadges(b.datetime);
        meta.innerHTML = meta.innerHTML.replace(/<(span class=\"badge-(live|soon)\")[\s\S]*?span>/g,'');
        meta.insertAdjacentHTML('beforeend', ' ' + badges);
      }
    });
  }, 30000);

  function getBadges(dt){
    const start = new Date(dt).getTime();
    const now = Date.now();
    const diff = start - now;
    if(diff <= 0 && diff > -2*3600*1000){
      return '<span class="badge-live">LIVE</span>';
    }
    if(diff > 0 && diff < 30*60*1000){
      return '<span class="badge-soon">Starting soon</span>';
    }
    return '';
  }

  function renderBarazas(list){
    barazaContainer.innerHTML = '';
    list.forEach(b => {
      const item = document.createElement('div');
      item.className = 'baraza-item card';
      const when = new Date(b.datetime).toLocaleString();
      const rel = formatRelative(b.datetime);
      const badges = getBadges(b.datetime);
      const tags = (b.tags||[]).map(t=>`<span class="chip">#${t}</span>`).join(' ');
      const isPast = new Date(b.datetime).getTime() < Date.now();
       const rec = '';
      const upcomingCtas = `
            <button class="small-btn primary" data-action="join" data-id="${b.id}">Join</button>
            ${rec}
            <button class="small-btn" data-action="rsvp" data-id="${b.id}">RSVP</button>
            <button class="small-btn" data-action="calendar" data-id="${b.id}">Add to Calendar</button>
            <button class="small-btn" data-action="remind" data-id="${b.id}">Remind Me</button>`;
       const pastCtas = ``;
      const highlights = isPast ? renderHighlights(b) : '';
      item.innerHTML = `
        <div class="baraza-meta">
          <div>
            <div class="baraza-title">${escapeHtml(b.title)}</div>
            <div class="baraza-datetime">${when} • ${escapeHtml(b.county)} • <span>${rel}</span> ${badges}</div>
            <div class="baraza-line2">
               <span class="chip">Host: ${escapeHtml(b.host)}</span>
               <span class="chip">👥 ${b.participants}</span>
               <span class="chip">Location: ${escapeHtml(b.location||'Venue TBC')}</span>
              ${tags}
          </div>
          <div class="baraza-cta">
            ${isPast ? pastCtas : upcomingCtas}
            <button class="vote-btn" data-action="vote-up" data-id="${b.id}">▲</button>
            <span data-role="up">${b.upvotes||0}</span>
            <button class="vote-btn" data-action="vote-down" data-id="${b.id}">▼</button>
            <span data-role="down">${b.downvotes||0}</span>
          </div>
          <div class="baraza-highlights">${highlights}</div>
        </div>`;
      item.dataset.id = String(b.id);
      barazaContainer.appendChild(item);
    });
    if(list.length===0){
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = '<div class="small-muted">No barazas match your filters.</div>';
      barazaContainer.appendChild(card);
    }
  }

  function renderHighlights(b){
    const hls = Array.isArray(b.highlights) ? b.highlights : [];
    if(hls.length===0) return '<div class="hl-wrap small-muted">No highlights added yet.</div>';
    return `<div class="hl-wrap">${hls.map(h=>`
      <div class="hl" data-hid="${h.id}">
        <div class="hl-text">${escapeHtml(h.text)}</div>
        <div class="hl-votes">
          <button class="vote-btn" data-action="hl-up" data-id="${b.id}" data-hid="${h.id}">▲</button>
          <span data-role="hl-up">${h.up||0}</span>
          <button class="vote-btn" data-action="hl-down" data-id="${b.id}" data-hid="${h.id}">▼</button>
          <span data-role="hl-down">${h.down||0}</span>
        </div>
      </div>`).join('')}</div>`;
  }

  function voteBaraza(id, value, el){
    // For demo: update locally
    const span = el.nextElementSibling;
    span.textContent = Number(span.textContent) + 1;
    const parent = el.closest('.baraza-cta');
    if(!parent) return;
    const up = parent.querySelector('span[data-role="up"]');
    const down = parent.querySelector('span[data-role="down"]');
    const item = barazaList.find(x=>String(x.id)===String(id));
    if(!item) return;
    if(value>0){ item.upvotes = (item.upvotes||0)+1; if(up) up.textContent = String(item.upvotes); }
    else { item.downvotes = (item.downvotes||0)+1; if(down) down.textContent = String(item.downvotes); }
    // TODO: POST to backend when available
    // fetch(VOTE_ENDPOINT(id), { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({vote:value}) })
  }

  function voteHighlight(b, hid, value, el){
    const list = Array.isArray(b.highlights) ? b.highlights : [];
    const h = list.find(x=>String(x.id)===String(hid));
    if(!h) return;
    if(value>0){ h.up = (h.up||0)+1; }
    else { h.down = (h.down||0)+1; }
    const wrap = el.closest('.hl');
    if(wrap){
      const up = wrap.querySelector('span[data-role="hl-up"]');
      const down = wrap.querySelector('span[data-role="hl-down"]');
      if(up) up.textContent = String(h.up||0);
      if(down) down.textContent = String(h.down||0);
    }
    // TODO: POST to backend
  }

  function openMeeting(baraza){
    modalTitle.textContent = baraza.title;
    modalMeta.textContent = new Date(baraza.datetime).toLocaleString() + " • " + baraza.county;
    modalIframe.innerHTML = `<iframe src="${baraza.meeting_link}" style="width:100%;height:100%;border:0" allow="camera; microphone; fullscreen"></iframe>`;
    overlay.classList.add('open');
  }

  modalClose.addEventListener('click', ()=>{ overlay.classList.remove('open'); modalIframe.innerHTML=''; });
  copyLinkBtn.addEventListener('click', ()=>{
    const iframe = modalIframe.querySelector('iframe');
    if(!iframe) return;
    navigator.clipboard.writeText(iframe.src);
    copyLinkBtn.textContent = 'Copied!';
    setTimeout(()=> copyLinkBtn.textContent = 'Copy Link', 1200);
  });

  document.addEventListener('DOMContentLoaded', loadBarazas);

  // ===== Delegated events & filters =====
  barazaContainer.addEventListener('click', (e)=>{
    const target = e.target;
    if(!(target instanceof Element)) return;
    const action = target.getAttribute('data-action');
    if(!action) return;
    const id = target.getAttribute('data-id');
    const baraza = barazaList.find(x=>String(x.id)===String(id));
    if(!baraza) return;
    if(action==='join'){
      openMeeting(baraza);
    } else if(action==='vote-up'){
      voteBaraza(id, 1, target);
    } else if(action==='vote-down'){
      voteBaraza(id, -1, target);
    } else if(action==='hl-up'){
      voteHighlight(baraza, target.getAttribute('data-hid'), 1, target);
    } else if(action==='hl-down'){
      voteHighlight(baraza, target.getAttribute('data-hid'), -1, target);
    } else if(action==='calendar'){
      addToCalendar(baraza);
    } else if(action==='rsvp'){
      toggleRsvp(baraza, target);
    } else if(action==='remind'){
      scheduleReminder(baraza, target);
    }
  });

  [bzSearch,bzCounty,bzFrom,bzTo,bzSort].forEach(el=>{
    if(!el) return;
    el.addEventListener('input', ()=> renderBarazas(applyBarazaFilters()));
    el.addEventListener('change', ()=> renderBarazas(applyBarazaFilters()));
  });

  tabButtons.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      tabButtons.forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      activeTab = btn.getAttribute('data-tab')||'upcoming';
      renderBarazas(applyBarazaFilters());
    });
  });

  // ===== RSVP / Calendar / Reminder =====
  const rsvpSet = new Set(JSON.parse(localStorage.getItem('wazi-bz-rsvp')||'[]'));
  function persistRsvp(){ localStorage.setItem('wazi-bz-rsvp', JSON.stringify(Array.from(rsvpSet))); }

  function toggleRsvp(b, btn){
    const key = String(b.id);
    if(rsvpSet.has(key)) { rsvpSet.delete(key); btn.textContent='RSVP'; }
    else { rsvpSet.add(key); btn.textContent='RSVP’d'; }
    persistRsvp();
  }

   function addToCalendar(b){
    const start = new Date(b.datetime);
    const end = new Date(start.getTime()+60*60*1000);
    const title = encodeURIComponent(b.title);
    const details = encodeURIComponent(`Join: ${b.meeting_link}`);
     const location = encodeURIComponent(b.location || b.county || 'Kenya');
    const iso = (d)=> d.toISOString().replace(/[-:]|\.\d{3}/g,'');
    const ics = `BEGIN:VCALENDAR\nVERSION:2.0\nBEGIN:VEVENT\nURL:${b.meeting_link}\nDTSTART:${iso(start)}\nDTEND:${iso(end)}\nSUMMARY:${title}\nDESCRIPTION:${details}\nLOCATION:${location}\nEND:VEVENT\nEND:VCALENDAR`;
    const blob = new Blob([ics], {type:'text/calendar'});
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `${title}.ics`;
    document.body.appendChild(link); link.click(); link.remove();
  }

  async function scheduleReminder(b, btn){
    try{
      const perm = await Notification.requestPermission();
      if(perm!=='granted') { alert('Enable notifications in your browser.'); return; }
      const dt = new Date(b.datetime).getTime();
      const due = Math.max(0, dt - Date.now() - 10*60*1000); // 10 min before
      btn.textContent = 'Reminder set';
      setTimeout(()=>{
        new Notification('Baraza starting soon', { body: `${b.title} in 10 minutes` });
      }, due);
    }catch{}
  }

  function escapeHtml(str){
    return String(str).replace(/[&<>"']/g, (c)=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));
  }

</script>
</body>
</html>